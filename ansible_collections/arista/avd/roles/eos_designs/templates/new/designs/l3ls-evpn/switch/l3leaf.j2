switch:
{% for l3leaf_node_group in l3leaf.node_groups | arista.avd.natural_sort %}
{%     for node in l3leaf.node_groups[l3leaf_node_group].nodes | arista.avd.natural_sort %}
{%         if node == inventory_hostname %}
{# switch.platform #}
  platform: {{ l3leaf.node_groups[l3leaf_node_group].platform | arista.avd.default(
               l3leaf.defaults.platform ) }}
{# switch.bgp_as #}
{%             if bgp_as is arista.avd.defined and switch.overlay_routing_protocol == 'ibgp' %}
  bgp_as: {{ bgp_as }}
{%             else %}
  bgp_as: {{ l3leaf.node_groups[l3leaf_node_group].nodes[node].bgp_as | arista.avd.default(
             l3leaf.node_groups[l3leaf_node_group].bgp_as,
             l3leaf.defaults.bgp_as ) }}
{%             endif %}
{# switch.mlag* #}
{%             set mlag = l3leaf.node_groups[l3leaf_node_group].mlag | arista.avd.default(
                          l3leaf.defaults.mlag,
                          true ) %}
  mlag_ibgp_origin_incomplete: {{ l3leaf.node_groups[l3leaf_node_group].mlag_ibgp_origin_incomplete | arista.avd.default(
                                  l3leaf.defaults.mlag_ibgp_origin_incomplete,
                                  true) }}
{%             if loop.length == 2 and mlag == true %}
  mlag: true
  mlag_ibgp: true
  mlag_group: {{ l3leaf_node_group }}
  mlag_dual_primary_detection: {{ l3leaf.node_groups[l3leaf_node_group].mlag_dual_primary_detection | arista.avd.default(
                                  l3leaf.defaults.mlag_dual_primary_detection,
                                  false ) }}
  mlag_interfaces: {{ l3leaf.node_groups[l3leaf_node_group].mlag_interfaces | arista.avd.default(
                                              l3leaf.defaults.mlag_interfaces ) }}
{%                 if loop.index == 1 %}
  mlag_role: {{ "primary" }}
  mlag_peer: {{ loop.nextitem }}
  mlag_ip: {{ (l3leaf.node_groups[l3leaf_node_group].nodes[node].id - 1) * 2 }}
  mlag_peer_ip: {{ ((l3leaf.node_groups[l3leaf_node_group].nodes[node].id - 1) * 2) + 1 }}
  mlag_peer_id: {{ l3leaf.node_groups[l3leaf_node_group].nodes[loop.nextitem].id }}
  mlag_peer_mgmt_ip: {{ l3leaf.node_groups[l3leaf_node_group].nodes[loop.nextitem].mgmt_ip | ipaddr('address') }}
{%                 elif loop.index == 2 %}
  mlag_role: "secondary"
  mlag_peer: {{ loop.previtem }}
  mlag_ip: {{ ((l3leaf.node_groups[l3leaf_node_group].nodes[loop.previtem].id - 1) * 2) + 1 }}
  mlag_peer_ip: {{ (l3leaf.node_groups[l3leaf_node_group].nodes[loop.previtem].id - 1) * 2 }}
  mlag_peer_id: {{ l3leaf.node_groups[l3leaf_node_group].nodes[loop.previtem].id }}
  mlag_peer_mgmt_ip: {{ l3leaf.node_groups[l3leaf_node_group].nodes[loop.previtem].mgmt_ip | ipaddr('address') }}
{%                 endif %}
{%             else %}
  mlag: false
{%             endif %}
{%         endif %}
{%     endfor %}
{% endfor %}
{##}
