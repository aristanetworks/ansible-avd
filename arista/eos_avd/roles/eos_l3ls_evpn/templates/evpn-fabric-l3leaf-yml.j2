{# leaf switch configuration  #}
## Ansible Generated ##

### {{ inventory_hostname }} ###

{# set leaf variables #}
{% set switch = namespace() %}
{% set leaf = namespace() %}
{% for l3leaf_node_group in l3leafs.node_groups | arista.eos_avd.natural_sort %}
{%     for node in l3leafs.node_groups[l3leaf_node_group].nodes | arista.eos_avd.natural_sort %}
{%         if node == inventory_hostname %}
{%             set leaf.group = l3leaf_node_group %}
{%             set leaf.id = l3leafs.node_groups[l3leaf_node_group].nodes[node].id %}
{%             set leaf.mgmt_ip = l3leafs.node_groups[l3leaf_node_group].nodes[node].mgmt_ip %}
{%             set leaf.spine_interfaces = l3leafs.node_groups[l3leaf_node_group].nodes[node].spine_interfaces %}
{%             if l3leafs.node_groups[l3leaf_node_group].spines is defined %}
{%                 set leaf.spines = l3leafs.node_groups[l3leaf_node_group].spines %}
{%             else %}
{%                 set leaf.spines = l3leafs.defaults.spines %}
{%             endif %}
{%             if l3leafs.node_groups[l3leaf_node_group].uplink_to_spine_interfaces is defined %}
{%                 set leaf.uplink_to_spine_interfaces = l3leafs.node_groups[l3leaf_node_group].uplink_to_spine_interfaces %}
{%             else %}
{%                 set leaf.uplink_to_spine_interfaces = l3leafs.defaults.uplink_to_spine_interfaces %}
{%             endif %}
{%             if l3leafs.node_groups[l3leaf_node_group].platform is defined %}
{%                 set switch.platform = l3leafs.node_groups[l3leaf_node_group].platform %}
{%             else %}
{%                 set switch.platform = l3leafs.defaults.platform %}
{%             endif %}
{%             if l3leafs.node_groups[l3leaf_node_group].bgp_as is defined %}
{%                 set leaf.bgp_as = l3leafs.node_groups[l3leaf_node_group].bgp_as %}
{%             else %}
{%                 set leaf.bgp_as = l3leafs.defaults.bgp_as %}
{%             endif %}
{%             if l3leafs.node_groups[l3leaf_node_group].spanning_tree_priority is defined %}
{%                 set leaf.spanning_tree_priority = l3leafs.node_groups[l3leaf_node_group].spanning_tree_priority %}
{%             else %}
{%                 set leaf.spanning_tree_priority = l3leafs.defaults.spanning_tree_priority %}
{%             endif %}
{%             if loop.length == 2 %}
{%                 set leaf.mlag = true %}
{%                 set leaf.mlag_group = l3leaf_node_group %}
{%                 if l3leafs.node_groups[l3leaf_node_group].mlag_interfaces is defined %}
{%                     set leaf.mlag_interfaces = l3leafs.node_groups[l3leaf_node_group].mlag_interfaces %}
{%                 else %}
{%                     set leaf.mlag_interfaces = l3leafs.defaults.mlag_interfaces %}
{%                 endif %}
{%                 if loop.index == 1 %}
{%                     set leaf.mlag_role = "primary" %}
{%                     set leaf.mlag_peer = loop.nextitem %}
{%                     set leaf.mlag_ip = (( l3leafs.node_groups[l3leaf_node_group].nodes[node].id -1 ) * 2 ) %}
{%                     set leaf.mlag_peer_ip = ((( l3leafs.node_groups[l3leaf_node_group].nodes[node].id -1 ) * 2 ) + 1 ) %}
{%                     set leaf.mlag_peer_id = l3leafs.node_groups[l3leaf_node_group].nodes[loop.nextitem].id %}
{%                 elif loop.index == 2 %}
{%                     set leaf.mlag_role = "secondary" %}
{%                     set leaf.mlag_peer = loop.previtem %}
{%                     set leaf.mlag_ip = ((( l3leafs.node_groups[l3leaf_node_group].nodes[loop.previtem].id -1 ) * 2 ) +1 ) %}
{%                     set leaf.mlag_peer_ip = (( l3leafs.node_groups[l3leaf_node_group].nodes[loop.previtem].id -1 ) * 2 )  %}
{%                     set leaf.mlag_peer_id = l3leafs.node_groups[l3leaf_node_group].nodes[loop.previtem].id  %}
{%                 endif %}
{%             else %}
{%                 set leaf.mlag = false %}
{%             endif %}
{%         endif %}
{%     endfor %}
{% endfor %}
### Leaf Info ###
l3leaf_node_group: {{ leaf.group }}
leaf_platform: {{ switch.platform }}
leaf_bgp_as: {{ leaf.bgp_as }}
leaf_id: {{ leaf.id }}
leaf_mgmt_ip: {{ leaf.mgmt_ip }}
leaf_mlag: {{ leaf.mlag }}
{% if leaf.mlag == true %}
leaf_mlag_group: {{ leaf.mlag_group }}
leaf_mlag_role: {{ leaf.mlag_role }}
leaf_mlag_peer: {{ leaf.mlag_peer }}
leaf_mlag_ip: {{ leaf.mlag_ip }}
leaf_mlag_peer_ip: {{ leaf.mlag_peer_ip }}
leaf_mlag_peer_id: {{ leaf.mlag_peer_id }}
{% endif %}







{# Daemon TerminAttr #}
### Daemon TerminAttr
daemon_terminattr:
{% include 'base/daemon-terminattr.j2' %}

{# name servers #}
### Name Servers ###
name_server:
{% include 'base/name-servers.j2' %}

{# NTP servers #}
### NTP Servers ###
ntp_server:
{% include 'base/ntp-servers.j2' %}

{# spanning-tree #}
### Spanning-tree ###
spanning_tree:
{% include 'base/leaf-spanning-tree.j2' %}
{# disable mlag vlan spanning tree #}
{% include 'mlag/leaf-mlag-spanning-tree.j2' %}

{# local users #}
### local users ###
local_users:
{% include 'base/local-users.j2' %}

{# VLANs #}
### VLANs ###
vlans:
{# mlag VLANs #}
{% include 'mlag/leaf-mlag-vlans.j2' %}

{# Tenants L2 VLANs #}
{% include 'tenant-evpn-vxlan/leaf-tenant-vlans.j2' %}

{# VRFs #}
### VRFs ###
vrfs:
{# management #}
{% include 'base/mgmt-vrf.j2' %}

{# Tenant VRFS #}
{% include 'tenant-evpn-vxlan/leaf-tenant-vrfs.j2' %}

{# bfd multihop #}
### bfd multihop ###
bfd_multihop:
{% include 'base/bfd-multihop.j2' %}

{# Port-Channel Interfaces #}
### Port-Channel Interfaces ###
port_channel_interfaces:
{# L2 Leaf uplinks #}
{% include 'l3leaf-l2leafs-uplinks/l3leaf-port-channel-uplinks.j2' %}
{# mlag peer-link #}
{% include 'mlag/leaf-mlag-peer-link.j2' %}
{# Server - Port Channel Interfaces #}
{% include 'edge-ports/leaf-server-port-channels.j2' %}

{# Ethernet Interfaces #}
### Ethernet Interfaces ###
ethernet_interfaces:
{# Point-to-Point Interfaces to Spine Switches #}
{% include 'underlay-overlay/leaf-p2p-interfaces.j2'%}
{# mlag interfaces #}
{% include 'mlag/leaf-mlag-interfaces.j2' %}
{# L2 Leaf uplinks #}
{% include 'l3leaf-l2leafs-uplinks/l3leaf-ethernet-uplinks.j2' %}
{# Server - Interfaces Configuration #}
{% include 'edge-ports/leaf-server-interfaces.j2' %}


{# loopback interfaces #}
### Loopback Interfaces ###
loopback_interfaces:
{# overlay peering interface #}
{% include 'underlay-overlay/leaf-overlay-loopback.j2'%}
{# intentional blank line #}

{# VTEP VXLAN Tunnel Source #}
{% include 'tenant-evpn-vxlan/leaf-vtep-vxlan-tunnel-loopback.j2'%}
{# Tenant VRF Loopback - to allow VTEPs daignostics from switch #}
{% include 'tenant-evpn-vxlan/leaf-tenant-vrf-loopbacks.j2' %}

{# Management Interfaces #}
### Management Interfaces ###
management_interfaces:
{% include 'base/leaf-mgmt-interface.j2' %}


{# vlan interfaces #}
### VLAN Interfaces ###
vlan_interfaces:
{# mlag vlan interfaces #}
{% include 'mlag/leaf-mlag-vlan-interfaces.j2' %}
{# Tenant vlan interfaces #}
{% include 'tenant-evpn-vxlan/leaf-tenant-vlan-interfaces.j2' %}

{# vxlan interface #}
### VxLAN interface ###
vxlan_tunnel_interface:
{% include 'tenant-evpn-vxlan/leaf-vxlan-vtep-interface.j2' %}

{# TCAM Profiles #}
### TCAM Profiles ###
tcam_profile:
{% include 'base/tcam-profile.j2' %}

{# virtual router mac address #}
ip_virtual_router_mac_address: {{ virtual_router_mac_address | lower }}

{# Tenant - Virtual Source NAT - to allow VTEPs daignostics from switch #}
virtual_source_nat_vrfs:
{% include 'tenant-evpn-vxlan/leaf-tenant-virtual-source-nat-vrfs.j2' %}

{# static_routes #}
### static routes ###
static_routes:
{% include 'routing/static-routes.j2' %}


{# prefix_lists #}
### prefix-lists ###
prefix_lists:
{% include 'underlay-overlay/leaf-prefix-lists.j2' %}

{# MLAG Configuration #}
{% include 'mlag/leaf-mlag-configuration.j2' %}

{# route maps #}
### route-maps ###
route_maps:
{% include 'underlay-overlay/route-maps.j2' %}

{# BGP Configurartion #}
### Routing - BGP ###
router_bgp:
{# underlay and overlay #}
{% include 'underlay-overlay/leaf-router-bgp.j2' %}

{# Tenant router bgp evpn #}
{% include 'tenant-evpn-vxlan/leaf-tenant-router-bgp-evpn.j2' %}